// Generated by CoffeeScript 1.7.1
(function() {
  (function($) {
    var categoryColour, categoryWidth, category_action, category_delete, category_edit, component_stash, modalLabels;
    component_stash = {};
    category_delete = "";
    category_edit = "";
    category_action = "";
    categoryWidth = function() {
      $(".categories").width(($(".panel").length) * 320);
      return void 0;
    };
    categoryColour = function() {
      var x, _i, _len, _ref;
      _ref = $(".panel");
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        x = _ref[_i];
        if ($(x).find(".panel-heading").find(".panel-title").text().toLowerCase().indexOf("emergency") > -1) {
          $(x).removeClass("panel-default");
          $(x).addClass("panel-danger");
        }
      }
      return void 0;
    };
    modalLabels = function() {
      if (category_action === "edit") {
        $("#category-modal .modal-dialog .modal-content .modal-header .modal-title").text("Edit category");
        $("#category-modal-submit").text("Update");
      } else {
        $("#category-modal .modal-dialog .modal-content .modal-header .modal-title").text("Add category");
        $("#category-modal-submit").text("Add");
      }
      return void 0;
    };
    categoryWidth();
    categoryColour();
    $(document.body).on("click", "a.new-category", function() {
      category_action = "new";
      modalLabels();
      $("#category-modal-title").val("");
      $("#category-modal").modal("show");
      return void 0;
    });
    $(document.body).on("click", "#category-modal-submit", function() {
      var component, title;
      title = $("#category-modal-title").val();
      if (category_action === "new") {
        component = 0;
        if (!("category" in component_stash)) {
          component = 1;
        }
        $.ajax({
          type: "POST",
          url: "/api/set/category/new",
          data: {
            component: component,
            id: $(".new-category:first").attr("data-board"),
            title: title
          },
          success: function(data) {
            var category;
            if (data.code !== 200) {
              console.log("ERROR: " + data.code);
            }
            if (component === 1) {
              component_stash.category = data.data.components;
            }
            category = component_stash.category;
            category = category.split("{{ c.id }}");
            category = category.join(data.data.id);
            category = category.replace("{{ c.title }}", title);
            $("div.categories").append(category);
            $("#category-modal").modal("hide");
            categoryWidth();
            categoryColour();
            return window.taskSortable();
          },
          error: function(jqXHR, textStatus, err) {
            return console.log(err);
          }
        });
      } else {
        $.ajax({
          type: "POST",
          url: "/api/set/category/update",
          data: {
            id: category_edit,
            title: title
          },
          success: function(data) {
            if (data.code !== 200) {
              console.log("ERROR: " + data.code);
            }
            $(".panel[data-category='" + category_edit + "'] .panel-heading .panel-title").text(title);
            $("#category-modal").modal("hide");
            category_edit = "";
            return categoryColour();
          },
          error: function(jqXHR, textStatus, err) {
            return console.log(err);
          }
        });
      }
      return void 0;
    });
    $(document.body).on("click", ".category-edit", function() {
      category_edit = $(this).closest(".panel").attr("data-category");
      category_action = "edit";
      modalLabels();
      $("#category-modal-title").val($(this).closest(".panel-heading").children(".panel-title").text());
      $("#category-modal").modal("show");
      return void 0;
    });
    $(document.body).on("click", ".category-delete", function() {
      category_delete = $(this).closest(".panel").attr("data-category");
      $("#delete-category-modal").modal("show");
      return void 0;
    });
    $(document.body).on("click", "#delete-category-yes", function() {
      $.ajax({
        type: "POST",
        url: "/api/set/category/delete",
        data: {
          id: category_delete
        },
        success: function(data) {
          if (data.code !== 200) {
            console.log("ERROR: " + data.code);
          }
          $("div.categories div.panel[data-category='" + category_delete + "']").remove();
          $("#delete-category-modal").modal("hide");
          categoryWidth();
          return category_delete = "";
        },
        error: function(jqXHR, textStatus, err) {
          return console.log(err);
        }
      });
      return void 0;
    });
    $(document.body).on("click", "#delete-category-no", function() {
      $("#delete-category-modal").modal("hide");
      return void 0;
    });
    return $(".categories").sortable({
      handle: ".reorder",
      placeholder: "placeholder-category",
      stop: function(e, ui) {
        var c;
        return $.ajax({
          type: "POST",
          url: "/api/set/category/order",
          data: {
            id: $(".categories").eq(0).attr("data-board"),
            order: JSON.stringify((function() {
              var _i, _len, _ref, _results;
              _ref = $("div.categories").find(".category");
              _results = [];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                c = _ref[_i];
                _results.push($(c).attr("data-category"));
              }
              return _results;
            })())
          },
          success: function(data) {
            if (data.code !== 200) {
              return console.log("ERROR: " + data.code);
            }
          },
          error: function(jqXHR, textStatus, err) {
            return console.log(err);
          }
        });
      }
    }).disableSelection();
  })(jQuery);

}).call(this);
